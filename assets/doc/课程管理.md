# 业务功能2——课程管理服务

- [概况](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%A6%82%E5%86%B5)

  - [课程管理包括的功能需求](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86%E5%8C%85%E6%8B%AC%E7%9A%84%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82)
  - [持久层技术介绍](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%8C%81%E4%B9%85%E5%B1%82%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D)
  - [数据表介绍](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%BB%8B%E7%BB%8D)

- [课程计划管理](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E8%AE%A1%E5%88%92%E7%AE%A1%E7%90%86)

  - [课程计划查询](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E8%AE%A1%E5%88%92%E6%9F%A5%E8%AF%A2)
    - [需求](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E9%9C%80%E6%B1%82)
    - [数据模型](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B)
    - [建立工程 xc-service-manage-course31200](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E5%BB%BA%E7%AB%8B%E5%B7%A5%E7%A8%8B-xc-service-manage-course31200)
  - [添加课程计划](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%B7%BB%E5%8A%A0%E8%AF%BE%E7%A8%8B%E8%AE%A1%E5%88%92)

- [课程管理](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86)

  - [PageHelper实现分页查询功能](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#pagehelper%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD)
  - [新增课程](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B)
    - [需求](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E9%9C%80%E6%B1%82-1)
    - [课程分类查询](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E5%88%86%E7%B1%BB%E6%9F%A5%E8%AF%A2)
  - [课程信息修改](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF%E4%BF%AE%E6%94%B9)
  - [课程营销](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E8%90%A5%E9%94%80)

- [课程图片管理](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E5%9B%BE%E7%89%87%E7%AE%A1%E7%90%86)

- [课程预览](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88)

- [课程发布](https://github.com/yingeer/xuechengEDU/blob/master/assets/doc/%E8%AF%BE%E7%A8%8B%E7%AE%A1%E7%90%86.md#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83)

  ​

## 概况

### 课程管理包括的功能需求

1. 分类管理
2. 新增课程
3. 修改课程
4. 预览课程
5. 发布课程



### 持久层技术介绍

课程管理服务使用MySQL数据库存储课程信息，持久层技术如下：

1. spring data jpa：用于表的基本CRUD。
2. mybatis：用于复杂的查询操作。
3. druid：使用阿里巴巴提供的spring boot 整合druid包druid-spring-boot-starter管理连接池。



### 数据表介绍

![xc_course数据表](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/xc_course%E6%A8%A1%E5%9E%8B.png)



## 课程计划管理

定义课程教学的章节内容（类似于目录），采用树型结构，包括两级，第一级是课程的大章节、第二级是大章节下属的小章节，每个小章节通常是一段视频，点击小章节在线学习。



### 课程计划查询

#### 需求

前端页面需要树型结构的数据来展示Tree组件，如下：

```javascript
[{
id: 1,
label: '一级 1',
children: [{
id: 4,
label: '二级 1‐1'
}]
}]
```



#### 数据模型

Teachplan

```java
@Data
@ToString
@Accessors(chain = true)
@Entity
@Table(name="teachplan")
@GenericGenerator(name = "jpa-uuid", strategy = "uuid")
public class Teachplan implements Serializable {
    private static final long serialVersionUID = -916357110051689485L;
    @Id
    @GeneratedValue(generator = "jpa-uuid")
    @Column(length = 32)
    private String id;
    private String pname;
    private String parentid;
    private String grade;
    private String ptype;
    private String description;
    private String courseid;
    private String status;
    private Integer orderby;
    private Double timelength;
    private String trylearn;

}
```

**这里的设置有个非常不好的地方，主键ID类型为uuid**。 因为uuid相对顺序的自增id来说是毫无规律可言的，新行的值不一定要比之前的主键的值要大，所以innodb无法做到总是把新行插入到索引的最后，而是需要为新行寻找新的合适的位置从而来分配新的空间。这个过程需要做很多额外的操作，数据的毫无顺序会导致数据分布散乱。[【参考】](https://www.cnblogs.com/wyq178/p/12548864.html)



TeachplanNode

```java
@Data
@ToString
public class TeachplanNode extends Teachplan {
	List<TeachplanNode> children;
}
```

非常简单，继承$\color{#FF3030}{TeachPlan}$，然后定义一个children属性指向下一层TeachplanNode



#### 建立工程 xc-service-manage-course31200



配置pom

```xml
......
	<dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
            <version>1.1.10</version>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
        </dependency>

.....
```



配置yaml

```yaml
server:
  port: 31200
spring:
  application:
    name: xc-service-manage-course

mybatis:
  #pojo别名扫描包
  type-aliases-package: com.xuecheng.framework.domain
  mapper-locations: classpath:com/xuecheng/manage_course/dao/*Mapper.xml

```



主启动类 

略~~



接口定义

```java
public interface CourseControllerApi {
	@ApiOperation("课程计划查询")
	public TeachplanNode findTeachplanList(String courseId);
}
```

1. dao

   1)  mapper接口

   ```java
   @Mapper
   public interface TeachplanMapper {
   	public TeachplanNode selectList(String courseId);
   }
   ```

   2) mapper映射文件

   ```xml
   <resultMap id="teacheplanResultMap" type="com.xuecheng.framework.domain.course.ext.TeachplanNode">
       <id column="one_id" property="id"/>
       <result column="one_pname" property="pname"/>
       <collection property="children" ofType="com.xuecheng.framework.domain.course.ext.TeachplanNode">
           <id column="two_id" property="id"/>
           <result column="two_pname" property="pname"/>
           <collection property="children" ofType="com.xuecheng.framework.domain.course.ext.TeachplanNode">
               <id property="id" column="three_id"/>
               <result property="pname" column="three_pname"/>
           </collection>
       </collection>
   </resultMap>

   <select id="selectList" resultMap="teacheplanResultMap" parameterType="java.lang.String">
       SELECT
           a.id one_id,
           a.pname one_pname,
           b.id two_id,
           b.pname two_pname,
           c.id three_id,
           c.pname three_pname
       FROM
           teachplan a
           LEFT JOIN teachplan b
           ON a.id = b.parentid
           LEFT JOIN teachplan c
           ON b.id = c.parentid
       WHERE a.parentid = '0'
         <if test="_parameter != null and _parameter != ''">
             AND a.courseid = #{courseId}
         </if>
       ORDER BY a.orderby,
                b.orderby,
                c.orderby

   </select>
   ```

这里定义了一个resultMap，把查出来的结果映射到TeachplanNode。mybatis中，判断参数是否为空要用 _parameter。sql语句用到了连接查询。 



service

```java
@Service
public class CourseService {
	@Autowired
	TeachplanMapper teachplanMapper;
	//查询课程计划
	public TeachplanNode findTeachplanList(String 	courseId){
	TeachplanNode teachplanNode = 			teachplanMapper.selectList(courseId);
	return teachplanNode;
	}
}

```



controller

```java
@RestController
@RequestMapping("/course")
public class CourseController implements CourseControllerApi {
	@Autowired
	CourseService courseService;
	//查询课程计划
	@Override
	@GetMapping("/teachplan/list/{courseId}")
	public TeachplanNode findTeachplanList(String courseId) {
		return courseService.findTeachplanList(courseId);
	}
}
```



测试

Get 请求：http://localhost:31200/course/teachplan/list/402885816243d2dd016243f24c030002

返回：![返回结果](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/course_teachpla_list%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C.png)



### 添加课程计划

[【代码参考】](https://github.com/yingeer/xuechengEDU/blob/master/xc-service-manage-course31200/src/main/java/com/xuecheng/manage_course/controller/CourseController.java#L34)

------



## 课程管理

上一个功能是对课程计划的管理，这个功能是对多个课程的管理，看一下前端

![我的课程](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/%E6%88%91%E7%9A%84%E8%AF%BE%E7%A8%8B.png)



### PageHelper实现分页查询功能

springboot上集成<u>pagehelper</u>  [【文章参考】](https://juejin.im/post/5e9043fd6fb9a03c53518981)

[【代码】](https://github.com/yingeer/xuechengEDU/blob/master/xc-service-manage-course31200/src/main/java/com/xuecheng/manage_course/controller/CourseController.java#L47)

测试：

![返回结果](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/course_list%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C.png)





### 新增课程

#### 需求

用户进入“我的课程”页面，点击“新增课程”，进入新增课程页面，填写课程分类信息，

课程分类需要有多级分类，需要方便用户去选择。

![新增课程—课程分类](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E2%80%94%E2%80%94%E8%AF%BE%E7%A8%8B%E5%88%86%E7%B1%BB.png)   

#### 课程分类查询

数据模型：前端要求返回一个三级模型（如下）

```java
[
{
value: 'zhinan',
label: '指南',
children: [{
value: 'shejiyuanze',
label: '设计原则',
children: [{
value: 'yizhi',
label: '一致'
}, {
value: 'fankui',
label: '反馈'
}, {
value: 'xiaolv',
label: '效率'
}, {
value: 'kekong',
label: '可控'
}]
}]
}
]

```

基于Category定义一个新的CategoryNode模型

```java
@Data
@ToString
public class CategoryNode extends Category {
	List<CategoryNode> children;
}
```

api  controller service ...

[【代码实现】](https://github.com/yingeer/xuechengEDU/blob/master/xc-service-manage-course31200/src/main/java/com/xuecheng/manage_course/controller/CategoryController.java#L26)

测试（json）:

![category_list返回结果](https://github.com/yingeer/xuechengEDU/blob/master/assets/img/course/category_list%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C.png)



### 课程信息修改











### 课程营销







------







## 课程图片管理  





------





## 课程预览 





------



## 课程发布